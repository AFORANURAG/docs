"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[403],{3905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>d});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=a.createContext({}),p=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},u=function(e){var t=p(e.components);return a.createElement(l.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},h=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,l=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),h=p(n),d=r,m=h["".concat(l,".").concat(d)]||h[d]||c[d]||o;return n?a.createElement(m,i(i({ref:t},u),{},{components:n})):a.createElement(m,i({ref:t},u))}));function d(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,i=new Array(o);i[0]=h;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:r,i[1]=s;for(var p=2;p<o;p++)i[p]=n[p];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}h.displayName="MDXCreateElement"},1423:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>i,default:()=>c,frontMatter:()=>o,metadata:()=>s,toc:()=>p});var a=n(7462),r=(n(7294),n(3905));const o={sidebar_position:5},i="Securing our database with authentication and Deploying our API to the web",s={unversionedId:"tutorials/rest-api-and-dynamodb/part-5",id:"tutorials/rest-api-and-dynamodb/part-5",title:"Securing our database with authentication and Deploying our API to the web",description:"Securing our database with authentication",source:"@site/docs/tutorials/rest-api-and-dynamodb/part-5.md",sourceDirName:"tutorials/rest-api-and-dynamodb",slug:"/tutorials/rest-api-and-dynamodb/part-5",permalink:"/tutorials/rest-api-and-dynamodb/part-5",draft:!1,editUrl:"https://github.com/cyclic-software/docs/blob/main/docs/tutorials/rest-api-and-dynamodb/part-5.md",tags:[],version:"current",sidebarPosition:5,frontMatter:{sidebar_position:5},sidebar:"tutorialSidebar",previous:{title:"Finishing up with routes to update and delete data",permalink:"/tutorials/rest-api-and-dynamodb/part-4"}},l={},p=[{value:"Securing our database with authentication",id:"securing-our-database-with-authentication",level:2},{value:"Deploying our API to the web, with Cyclic",id:"deploying-our-api-to-the-web-with-cyclic",level:2},{value:"Where to go from here",id:"where-to-go-from-here",level:2}],u={toc:p};function c(e){let{components:t,...n}=e;return(0,r.kt)("wrapper",(0,a.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"securing-our-database-with-authentication-and-deploying-our-api-to-the-web"},"Securing our database with authentication and Deploying our API to the web"),(0,r.kt)("h2",{id:"securing-our-database-with-authentication"},"Securing our database with authentication"),(0,r.kt)("p",{align:"center"},(0,r.kt)("img",{alt:"Browsers sending an authorization HTTP header to the web server.",src:"/img/tutorial/rest-api/Auth.png",width:"640"})),(0,r.kt)("p",null,"Every public (and private) API must come with some sort of protection around its data. We mustn't allow anyone in the world to poke around our important database."),(0,r.kt)("p",null,"And while there are various authentication methods out there, ",(0,r.kt)("a",{parentName:"p",href:"https://swagger.io/docs/specification/authentication/bearer-authentication/"},"Bearer")," is one of the simplest."),(0,r.kt)("p",null,"It's quite simple: we give users a token (they're the ",(0,r.kt)("em",{parentName:"p"},"bearer")," of that token), we give that token some privileges (such as only reading or also writing and deleting) and finally we require the use of that token when making ",(0,r.kt)("a",{parentName:"p",href:"https://developer.mozilla.org/en-US/docs/Glossary/Safe/HTTP"},"unsafe HTTP requests"),"."),(0,r.kt)("p",null,"We won't be implementing privileges and roles to keep this guide simple, but we'll be using Bearer authentication. Get started by installing the ",(0,r.kt)("a",{parentName:"p",href:"https://www.npmjs.com/package/jsonwebtoken"},(0,r.kt)("inlineCode",{parentName:"a"},"jsonwebtoken"))," package; it's an implementation of ",(0,r.kt)("a",{parentName:"p",href:"https://jwt.io/"},"JSON Web Tokens"),", an standard for creating and checking credentials across the Internet."),(0,r.kt)("p",null,"After that, create an ",(0,r.kt)("inlineCode",{parentName:"p"},"auth.js")," file, which will contain two important utilities for Bearer authentication."),(0,r.kt)("p",null,"The first one is an Express middleware that's run before every route handler we desire. It's there to help us avoid repetition, so we can instead write all the authentication logic in one function and not worry about it anymore."),(0,r.kt)("p",null,"We expect auth-enabled routes to receive an ",(0,r.kt)("inlineCode",{parentName:"p"},"Authorization")," HTTP header containing a value in the form ",(0,r.kt)("inlineCode",{parentName:"p"},"Bearer <TOKEN>"),", so let's start by extracting the ",(0,r.kt)("inlineCode",{parentName:"p"},"<TOKEN>"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},'// auth.js\n\nimport jwt from "jsonwebtoken";\n\nexport function authenticateUser(req, res, next) {\n  const authHeader = req.headers["authorization"];\n  const bearerToken = authHeader && authHeader.split(" ")[1];\n\n  if (!bearerToken) {\n    res.sendStatus(401); // 401 UNAUTHORIZED\n  }\n}\n')),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://github.com/cyclic-software/tutorial-bikes-api/blob/main/auth.js"},"Link to full code.")),(0,r.kt)("p",null,"We'll proceed by verifying the validity of this token using the ",(0,r.kt)("inlineCode",{parentName:"p"},"verify()")," method. But before we do that, it's important to note that Bearer authentication depends on one secret stored in the environment variables. With this secret value, Bearer tokens are both generated and verified."),(0,r.kt)("p",null,"Let's create our token by running the following command:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},'// generate-secret.js\nrequire("crypto").randomBytes(64).toString("hex");\n')),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"node generate-secret.js\n")),(0,r.kt)("p",{align:"center"},(0,r.kt)("img",{alt:"Response to the last command.",src:"/img/tutorial/rest-api/gen-token.svg",width:"640"})),(0,r.kt)("p",null,"Copy that token and paste it in your ",(0,r.kt)("inlineCode",{parentName:"p"},".env")," file with the key name: ",(0,r.kt)("inlineCode",{parentName:"p"},'"TOKEN_SECRET"'),"."),(0,r.kt)("p",null,"Let's delve back into our code:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"if (!bearerToken) {\n  res.sendStatus(401);\n} else {\n  jwt.verify(bearerToken, process.env.TOKEN_SECRET, (err, user) => {\n    if (err) {\n      console.log(err);\n      res.sendStatus(403); // 403 FORBIDDEN\n    } else {\n      req.user = user;\n      next();\n    }\n  });\n}\n")),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://github.com/cyclic-software/tutorial-bikes-api/blob/main/auth.js"},"Link to full code.")),(0,r.kt)("p",null,"Every ",(0,r.kt)("a",{parentName:"p",href:"http://expressjs.com/en/guide/using-middleware.html"},"Express middleware")," is handed a ",(0,r.kt)("inlineCode",{parentName:"p"},"next()")," function, which is simply called to run the default route handler. We're calling it when there's no error with verification, meaning that the Bearer token is correct."),(0,r.kt)("p",null,"Let's go back into our router code and add this middleware to all our ",(0,r.kt)("a",{parentName:"p",href:"https://developer.mozilla.org/en-US/docs/Glossary/Safe/HTTP"},"unsafe HTTP method")," handlers:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},'import { authenticateUser } from "./auth.js";\n\nrouter.post("/", authenticateUser, ... )\nrouter.put("/:id", authenticateUser, ... )\nrouter.patch("/:id", authenticateUser, ... )\nrouter.delete("/:id", authenticateUser, ... )\n')),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://github.com/cyclic-software/tutorial-bikes-api/blob/main/router.js"},"Link to full code.")),(0,r.kt)("p",null,"And yes, the second parameter just became the middlware function, while the route handler was pushed to the next position. This is totally possible because JavaScript supports a ",(0,r.kt)("a",{parentName:"p",href:"https://stackoverflow.com/a/457589"},"clever workaround")," for ",(0,r.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/Function_overloading"},"overloading"),", a programming language feature that allows functions to have the same names but different parameters."),(0,r.kt)("p",null,"Let's try it out now:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"curl -X DELETE http://localhost:3000/bikes/<ID> # replace <ID> with an ID from the response to /all\n")),(0,r.kt)("p",{align:"center"},(0,r.kt)("img",{alt:"Response to the last command.",src:"/img/tutorial/rest-api/http-unauthorized.svg",width:"640"})),(0,r.kt)("p",null,"Unsurprisingly, we're now getting the ",(0,r.kt)("inlineCode",{parentName:"p"},"401 UNAUTHORIZED")," response that we previously programmed when there was no Bearer token in the request. Let's go ahead and add one new route to generate Bearer tokens. This one will directly go into ",(0,r.kt)("inlineCode",{parentName:"p"},"index.js")," as we don't want it to be prefixed with the ",(0,r.kt)("inlineCode",{parentName:"p"},"bikes/")," route."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},'// Create new bearer token\napp.post("/api/user", (req, res) => {\n  const username = req.body.username;\n\n  const token = ""; // TODO\n  res.send({ token });\n});\n')),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://github.com/cyclic-software/tutorial-bikes-api/blob/main/index.js"},"Link to full code.")),(0,r.kt)("p",null,"We still need a utility function that generated the Bearer tokens. Head back to the ",(0,r.kt)("inlineCode",{parentName:"p"},"auth.js")," file and add the following:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},'// auth.js\n\nexport function generateAccessToken(username) {\n  return jwt.sign(username, process.env.TOKEN_SECRET, { expiresIn: "1800s" });\n}\n')),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://github.com/cyclic-software/tutorial-bikes-api/blob/main/auth.js"},"Link to full code.")),(0,r.kt)("p",null,"As you can see, we're using the same secret to generate our Bearer tokens, and we're also setting them to expire in 30 minutes (or 1800 seconds). We can now finish our token route:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},'import { generateAccessToken } from "./auth.js";\n\n// Create new bearer token\napp.post("/api/user", (req, res) => {\n  const username = req.body.username;\n\n  const token = generateAccessToken({ username });\n  res.send({ token });\n});\n')),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://github.com/cyclic-software/tutorial-bikes-api/blob/main/index.js"},"Link to full code.")),(0,r.kt)("p",null,"And with that done, we can easily generate new tokens and use them in our API requests. Restart your server (",(0,r.kt)("inlineCode",{parentName:"p"},"CTRL"),"+",(0,r.kt)("inlineCode",{parentName:"p"},"C")," then ",(0,r.kt)("inlineCode",{parentName:"p"},"npm run dev"),") and run the following command:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"curl -H 'Content-Type: application/json' http://localhost:3000/api/user -d '{\"username\": \"cyclic\"}' | jq .token -r\n")),(0,r.kt)("p",null,'Let\'s add an "Authorization" header to our new request:'),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'export TOKEN=<TOKEN> # replace <TOKEN> with the token from /api/user\ncurl -H "Authorization: Bearer $TOKEN" -X DELETE http://localhost:3000/bikes/<ID> | jq . # replace <ID> with an ID from the response to /all\n')),(0,r.kt)("p",{align:"center"},(0,r.kt)("img",{alt:"Response to the last command.",src:"/img/tutorial/rest-api/http-delete-auth.svg",width:"640"})),(0,r.kt)("h2",{id:"deploying-our-api-to-the-web-with-cyclic"},"Deploying our API to the web, with Cyclic"),(0,r.kt)("p",null,"We just created a full-fledged RESTful API that could be used to build an e-commerce store for bikes. Through this journey, we learnt about servers, HTTP, RESTful APIs, AWS DynamoDB and how Cyclic brings all these technologies together into one using its distinct starter templates."),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://deploy.cyclic.sh/cyclic-software/tutorial-bikes-api"},(0,r.kt)("img",{parentName:"a",src:"https://deploy.cyclic.sh/button.svg",alt:"Deploy to Cyclic"}))),(0,r.kt)("p",{align:"center"},(0,r.kt)("img",{alt:"Deployments tab in Cyclic dashboard showing the deployment history.",src:"/img/tutorial/rest-api/app.cyclic.sh_.png",width:"640"})),(0,r.kt)("p",null,"Let's commit all our new changes back into our code repository and let Cyclic automatically deploy these new changes to the web. We can track this process in Cylic's Deployments dashboard."),(0,r.kt)("p",{align:"center"},(0,r.kt)("img",{alt:"Variables tab in Cyclic dashboard showing two environment variables: token secret and cyclic DB.",src:"/img/tutorial/rest-api/ENV.png",width:"640"})),(0,r.kt)("p",null,"And since ",(0,r.kt)("inlineCode",{parentName:"p"},".env")," files are not committed publicly to GitHub repositories (since they're supposed to be secret), we must head back to the Cyclic dashboard and manually paste those values."),(0,r.kt)("p",{align:"center"},(0,r.kt)("img",{alt:"Environments tab in Cyclic dashboard showing the custom subdomain.",src:"/img/tutorial/rest-api/app.cyclic.sh__(2).png",width:"640"})),(0,r.kt)("p",null,"Furthermore, we can give our API its own custom subdomain, for free! \ud83d\ude03"),(0,r.kt)("p",null,"Our API is now live and we can use it the same way we did when it was running locally on our machine, but this time we'll replace the ",(0,r.kt)("a",{parentName:"p",href:"http://localhost"},"localhost")," domain with the server's domain."),(0,r.kt)("h2",{id:"where-to-go-from-here"},"Where to go from here"),(0,r.kt)("p",null,"We could still add a variety of endpoints to our API:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"GET"),"ting items by category,"),(0,r.kt)("li",{parentName:"ul"},"advanced searching capabilities using ",(0,r.kt)("a",{parentName:"li",href:"https://aws.amazon.com/about-aws/whats-new/2015/08/amazon-dynamodb-elasticsearch-integration/"},"ElasticSearch")," (it has a free-tier!)")),(0,r.kt)("p",null,"and many more things. You can get as creative as you want with it, you'll only be learning new things along the way!"),(0,r.kt)("p",null,"Get inspired by the plethora of ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/public-apis/public-apis"},"public APIs")," out there, attempt rebuilding them while adding your own personal touch, deploy them on Cyclic and you'll soon be the one teaching all this stuff! \ud83d\udcaa"))}c.isMDXComponent=!0}}]);